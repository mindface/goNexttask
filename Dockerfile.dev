FROM golang:1.21-alpine

RUN apk add --no-cache git gcc musl-dev

# Go 1.21と互換性のあるairバージョンを使用
RUN go install github.com/cosmtrek/air@v1.49.0

WORKDIR /app

COPY go.mod ./
COPY go.sum ./

RUN go mod download

COPY . .

# マイグレーション実行用スクリプト
RUN echo '#!/bin/sh' > /app/entrypoint.sh && \
    echo 'echo "Running migrations..."' >> /app/entrypoint.sh && \
    echo 'go run cmd/migrate/main.go' >> /app/entrypoint.sh && \
    echo 'echo "Starting air..."' >> /app/entrypoint.sh && \
    echo 'exec air -c .air.toml' >> /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

EXPOSE 8080

CMD ["/app/entrypoint.sh"]